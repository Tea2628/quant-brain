# 规格-风控与审批（v0.1 草案）

> 目标：定义全链路风控规则与审批状态机，确保任何 Proposal 必须通过校验与人工确认后才能进入执行。

## 1. 风控规则（Risk Rules）
- **仓位上限**：单笔 size ≤ 0.5，总仓位 ≤ 2.0
- **黑名单**：不允许交易 `LUNA/USDT`、`XYZ/USDT`
- **交易时段**：仅允许 08:00–22:00（UTC+8）
- **回撤限制**：账户最大回撤 ≥ -10% 时，禁止新建提案
- **杠杆范围**：仅允许 1x–3x（若接入）

## 2. 审批状态机（Approval Workflow）
- **干跑模式（默认）**：2 步确认  
  1. Trader → 提交 Proposal  
  2. Admin → 审批通过 → 可执行（dry-run）
- **实盘模式**：3 步确认  
  1. Trader → 提交 Proposal  
  2. Reviewer → 审批（风控岗）  
  3. Admin → 终审  
  → 全部通过后才能执行（live）

## 3. 错误码与拒绝原因
- `RISK_REJECTED(4002)`：违反仓位/黑名单/时段/回撤
- `APPROVAL_REQUIRED(4003)`：未通过审批步骤
- `PERMISSION_DENIED(4004)`：无权限审批
- `CONFLICT(4090)`：状态冲突（重复审批等）

## 4. 接口契约（示例）
- `POST /proposals/{id}/validate`
  - 入参：Proposal JSON
  - 出参：`{status:"valid"|"rejected", reasons:[...]}`

- `POST /proposals/{id}/approve`
  - 入参：`{step:"dry-1"|"dry-2"|"live-1"|"live-2"|"live-3", decision:"approved"|"rejected", reason?}`
  - 出参：`{status:"approved"|"rejected", trace_id}`

## 5. 事件流（WS）
- `risk.rejected`
- `approval.requested`
- `approval.granted`
- `approval.rejected`
- `execution.blocked`

## 6. 审计字段（最少集）
`{proposal_id, step, actor, decision, reason?, ts, trace_id}`

## 7. 验收（DoD）
- 边界用例（超仓位、黑名单、时段外、回撤过限）均能被拒绝
- 审批缺失时禁止执行
- 日志与事件流可回放每一步
